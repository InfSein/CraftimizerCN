name: Build and Release Plugin

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Setup .NET SDK
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '9.0'

    - name: Install dependencies
      run: |
        dotnet restore

    - name: Build plugin
      run: |
        dotnet build --configuration Release

    - name: Pack plugin
      run: |
        dotnet publish --configuration Release --output ./publish

    - name: Prepare Release Files
      run: |
        mkdir -p ./release
        cp -r ./publish/* ./release/

    - name: Create Release
      id: create_release
      run: |
        release=$(curl -s -XPOST -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          -d '{"tag_name":"${GITHUB_SHA}","name":"${GITHUB_SHA}","body":"Release of ${GITHUB_SHA}"}' \
          https://api.github.com/repos/${{ github.repository }}/releases)
        echo "::set-output name=release_id::$(echo $release | jq .id)"

    - name: Upload release asset
      run: |
        curl -XPOST -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          -H "Content-Type: application/octet-stream" \
          --data-binary @./release/Craftimizer.dll \
          https://uploads.github.com/repos/${{ github.repository }}/releases/${{ steps.create_release.outputs.release_id }}/assets?name=Craftimizer.dll
